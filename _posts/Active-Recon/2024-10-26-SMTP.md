---

layout: post  
title: "SMTP Enumeration"  
date: 2024-10-26  
categories: Active-Recon 

---

## Table of Contents

1. [Introduction to SMTP Enumeration](#introduction-to-smtp-enumeration)  
2. [Understanding SMTP](#understanding-smtp)  
3. [Enumerating SMTP Users](#enumerating-smtp-users)  
   1. [Using VRFY Command](#using-vrfy-command)  
   2. [Using EXPN Command](#using-expn-command)  
   3. [Using RCPT TO Command](#using-rcpt-to-command)  
4. [SMTP Enumeration Tools](#smtp-enumeration-tools)  
5. [Practical Examples](#practical-examples)  
6. [Defense and Mitigation](#defense-and-mitigation)  
7. [References](#references)  

---

## Introduction to SMTP Enumeration

SMTP (Simple Mail Transfer Protocol) is primarily used for email exchange, running on **port 25** by default. Penetration testers often leverage SMTP for **user enumeration** by querying the server to check if specific users exist, revealing potential valid accounts. This enumeration process helps identify possible email addresses and user accounts for further attacks, such as phishing or brute-forcing.

## Understanding SMTP

SMTP functions through various commands allowing mail exchange and server communication. Understanding the commands utilized for enumeration—**VRFY**, **EXPN**, and **RCPT TO**—is crucial, as they interact differently depending on server configuration and security settings.

### SMTP Command Overview

- **VRFY**: Verifies if a specified username exists.
- **EXPN**: Expands a mailing list to reveal individual recipients.
- **RCPT TO**: Typically used during email sending to specify recipients, but also used for user verification.

Not all servers respond positively to these commands, especially if they’re hardened against enumeration techniques.

---

## Enumerating SMTP Users

### 1. Using VRFY Command

The `VRFY` command checks if a user exists on the SMTP server.

#### Syntax and Example

```bash
VRFY <username>
```

#### Practical Usage

```bash
telnet target_ip 25
VRFY johndoe
```

**Expected Responses**:

- `250 OK - User johndoe exists` (indicates a valid user)
- `550 No such user here` (user does not exist)

#### Additional Notes

Using VRFY often reveals more than just the existence of a user; it may also provide their full name and email address. However, many modern servers disable this command to prevent enumeration.

### 2. Using EXPN Command

The `EXPN` command is designed to expand aliases and mailing lists, showing individual users behind a group alias.

#### Syntax and Example

```bash
EXPN <group-alias>
```

#### Practical Usage

```bash
telnet target_ip 25
EXPN support_team
```

**Expected Responses**:

- `250 OK - List expanded` (followed by a list of email addresses in the group)
- `550 Requested action not taken: mailbox unavailable` (alias does not exist or is protected)

### 3. Using RCPT TO Command

Typically used during email sending, `RCPT TO` can be adapted for enumeration by checking the validity of an email address.

#### Syntax and Example

```bash
RCPT TO:<user@domain>
```

#### Practical Usage

```bash
telnet target_ip 25
MAIL FROM:<tester@domain>
RCPT TO:<johndoe@domain>
```

**Expected Responses**:

- `250 OK - Recipient exists` (user exists)
- `550 No such user here` (user does not exist)

The `RCPT TO` method is often more successful since some servers do not explicitly block it.

---

## SMTP Enumeration Tools

Several tools can automate SMTP enumeration:

- **Metasploit Framework**: Includes auxiliary modules for SMTP enumeration.
  
  ```bash
  use auxiliary/scanner/smtp/smtp_enum
  set RHOSTS target_ip
  set USER_FILE /path/to/userlist.txt
  run
  ```

- **Nmap NSE Scripts**: Nmap has scripts for SMTP enumeration, such as `smtp-enum-users`.
  
  ```bash
  nmap -p 25 --script smtp-enum-users --script-args smtp-enum-users.userdb=userlist.txt target_ip
  ```

- **Telnet**: Basic enumeration can be done using Telnet, as shown in the examples above.

- **Python Scripts**: Custom scripts allow flexibility and can be configured to test specific commands.

---

## Practical Examples

### Example 1: Enumerating Users with Metasploit

Using Metasploit, configure the `smtp_enum` module:

```bash
use auxiliary/scanner/smtp/smtp_enum
set RHOSTS 192.168.1.10
set USER_FILE /path/to/usernames.txt
run
```

### Example 2: Nmap Enumeration Script

Nmap’s NSE script `smtp-enum-users` allows user enumeration:

```bash
nmap -p 25 --script smtp-enum-users --script-args smtp-enum-users.userdb=userlist.txt 192.168.1.10
```

### Example 3: Basic Telnet Enumeration

1. Open a connection with Telnet:

   ```bash
   telnet 192.168.1.10 25
   ```

2. Use `VRFY` and `EXPN` commands to test usernames directly:

   ```bash
   VRFY admin
   EXPN marketing_team
   ```

---

## Defense and Mitigation

To mitigate SMTP enumeration:

1. **Disable VRFY and EXPN**: Configure the SMTP server to disable these commands.
2. **Use Firewalls**: Restrict access to SMTP servers, limiting exposure to trusted IPs.
3. **Logging and Monitoring**: Regularly log and review SMTP traffic for unusual activity, particularly repeated enumeration attempts.
4. **Rate Limiting**: Configure limits to prevent brute-force enumeration techniques.

---

## References

- [RFC 5321 - Simple Mail Transfer Protocol](https://tools.ietf.org/html/rfc5321)
- [Nmap Scripting Engine (NSE) Scripts for SMTP](https://nmap.org/nsedoc/scripts/smtp-enum-users.html)
- [Metasploit SMTP Enum Module Documentation](https://www.rapid7.com/db/modules/auxiliary/scanner/smtp/smtp_enum)

--- 